# Run unit tests across all SDKs.
#
# This workflow runs unit tests only (no VM/integration tests).
# GitHub runners do not support nested virtualization, so we cannot run
# tests that require actual VMs.
#
# Test coverage:
# - Rust: cargo test (unit tests only)
# - Python: pytest with -m "not integration"
# - Node.js: vitest (all tests are unit tests)
name: Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  # Load shared configuration
  config:
    uses: ./.github/workflows/config.yml

  # Rust unit tests (boxlite-shared only - boxlite requires native libs not available in CI)
  rust:
    name: Rust Tests (${{ matrix.platform.target }})
    needs: config
    runs-on: ${{ matrix.platform.os }}
    strategy:
      fail-fast: false
      matrix:
        platform: ${{ fromJson(needs.config.outputs.platforms) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Install Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ needs.config.outputs.rust-toolchain }}

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install protobuf

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: boxlite-test

      - name: Run Rust unit tests
        # Only test boxlite-shared - boxlite requires libkrun/libgvproxy not available in CI
        run: cargo test -p boxlite-shared --lib

  # Python SDK unit tests
  python:
    name: Python Tests (${{ matrix.platform.target }} / Python ${{ matrix.python-version }})
    needs: config
    runs-on: ${{ matrix.platform.os }}
    strategy:
      fail-fast: false
      matrix:
        platform: ${{ fromJson(needs.config.outputs.platforms) }}
        python-version: ${{ fromJson(needs.config.outputs.python-versions) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-asyncio

      - name: Run Python unit tests
        working-directory: sdks/python
        run: python -m pytest tests/ -v -m "not integration"

  # Node.js SDK unit tests
  node:
    name: Node.js Tests (${{ matrix.platform.target }} / Node ${{ matrix.node-version }})
    needs: config
    runs-on: ${{ matrix.platform.os }}
    strategy:
      fail-fast: false
      matrix:
        platform: ${{ fromJson(needs.config.outputs.platforms) }}
        node-version: ${{ fromJson(needs.config.outputs.node-versions) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Install dependencies
        working-directory: sdks/node
        run: npm install

      - name: Run Node.js unit tests
        working-directory: sdks/node
        run: npm run test
