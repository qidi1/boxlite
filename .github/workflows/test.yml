# Run unit tests across all SDKs.
#
# This workflow runs unit tests only (no VM/integration tests).
# GitHub runners do not support nested virtualization, so we cannot run
# tests that require actual VMs.
#
# Test coverage:
# - Rust: cargo test (unit tests only)
# - Python: pytest with -m "not integration"
# - Node.js: vitest (all tests are unit tests)
name: Test

on:
  push:
    branches: [main]
    paths:
      - 'boxlite/**'
      - 'boxlite-shared/**'
      - 'boxlite-cli/**'
      - 'guest/**'
      - 'sdks/**'
      - '**/Cargo.toml'
      - 'Cargo.lock'
      - '.github/workflows/test.yml'
      - '.github/workflows/config.yml'
  pull_request:
    branches: [main]
    paths:
      - 'boxlite/**'
      - 'boxlite-shared/**'
      - 'boxlite-cli/**'
      - 'guest/**'
      - 'sdks/**'
      - '**/Cargo.toml'
      - 'Cargo.lock'
      - '.github/workflows/test.yml'
      - '.github/workflows/config.yml'

env:
  CARGO_TERM_COLOR: always

jobs:
  # Load shared configuration
  config:
    uses: ./.github/workflows/config.yml

  # Detect which files changed to conditionally run tests
  changes:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    outputs:
      rust: ${{ steps.filter.outputs.rust }}
      cli: ${{ steps.filter.outputs.boxlite_cli }}
      python: ${{ steps.filter.outputs.python }}
      node: ${{ steps.filter.outputs.node }}
    steps:
      - uses: actions/checkout@v5
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            rust:
              - 'boxlite/**'
              - 'boxlite-shared/**'
              - 'guest/**'
              - '**/Cargo.toml'
              - 'Cargo.lock'
            cli:
              - 'boxlite-cli/**'
            python:
              - 'sdks/python/**'
            node:
              - 'sdks/node/**'

  # Rust unit tests (boxlite-shared only - boxlite requires native libs not available in CI)
  rust:
    name: Rust Tests (${{ matrix.platform.target }})
    needs: [config, changes]
    if: ${{ needs.changes.outputs.rust == 'true' }}
    runs-on: ${{ matrix.platform.os }}
    strategy:
      fail-fast: false
      matrix:
        platform: ${{ fromJson(needs.config.outputs.platforms) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Install Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ needs.config.outputs.rust-toolchain }}

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install protobuf

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: boxlite-test

      - name: Run Rust unit tests
        # Only test boxlite-shared - boxlite requires libkrun/libgvproxy not available in CI
        run: cargo test -p boxlite-shared --lib

  # cli unit tests (integration tests in tests/ are ignored - require VM)
  cli:
    name: CLI Unit Tests (${{ matrix.platform.target }})
    needs: [config, changes]
    if: ${{ needs.changes.outputs.cli == 'true' }}
    runs-on: ${{ matrix.platform.os }}
    strategy:
      fail-fast: false
      matrix:
        platform: ${{ fromJson(needs.config.outputs.platforms) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Install Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ needs.config.outputs.rust-toolchain }}

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install protobuf

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: boxlite-test

      - name: Run boxlite-cli unit tests
        # Only run tests in src/ (name contains "::tests::"); skip integration tests in tests/ (require VM)
        env:
          BOXLITE_DEPS_STUB: "1"
        run: cargo test -p boxlite-cli -- "::tests::"

  # Python SDK unit tests
  python:
    name: Python Tests (${{ matrix.platform.target }} / Python ${{ matrix.python-version }})
    needs: [config, changes]
    if: ${{ needs.changes.outputs.python == 'true' }}
    runs-on: ${{ matrix.platform.os }}
    strategy:
      fail-fast: false
      matrix:
        platform: ${{ fromJson(needs.config.outputs.platforms) }}
        python-version: ${{ fromJson(needs.config.outputs.python-versions) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-asyncio

      - name: Run Python unit tests
        working-directory: sdks/python
        run: python -m pytest tests/ -v -m "not integration"

  # Node.js SDK unit tests
  node:
    name: Node.js Tests (${{ matrix.platform.target }} / Node ${{ matrix.node-version }})
    needs: [config, changes]
    if: ${{ needs.changes.outputs.node == 'true' }}
    runs-on: ${{ matrix.platform.os }}
    strategy:
      fail-fast: false
      matrix:
        platform: ${{ fromJson(needs.config.outputs.platforms) }}
        node-version: ${{ fromJson(needs.config.outputs.node-versions) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Install dependencies
        working-directory: sdks/node
        run: npm install

      - name: Run Node.js unit tests
        working-directory: sdks/node
        run: npm run test
